<!-- public/library.html  -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Template Library</title>

  <!-- dark-theme you already ship -->
  <link rel="stylesheet" href="/css/formBuilder.css" />

  <!-- ───── library-specific overrides ───── -->
  <style>
    /* ───────── folder bar ───────── */
    .folder-panel            { margin-bottom:1.25rem; }
    .folder-header           {
      display:flex;justify-content:space-between;align-items:center;
      background:#333;padding:12px 20px;border-radius:12px;
      cursor:pointer;user-select:none;transition:background .15s ease;
    }
    .folder-header:hover     { background:#505050; }
    .folder-name             { font-size:1.1rem;font-weight:600; }
    .folder-toggle           { font-size:1.1rem;transition:transform .2s ease; }
    .folder-panel.collapsed .folder-toggle { transform:rotate(90deg); }

    /* ───────── template pills ─────── */
    .folder-body             {           /* flex row of pills */
      padding:14px 20px 4px;display:flex;flex-wrap:wrap;gap:8px;
    }
    .folder-panel.collapsed .folder-body { display:none; }

    .template-pill{                      /* ▲ changed */
      position:relative;
      background:#333;                   /* same as fieldset button */
      padding:6px 40px 6px 16px;         /* extra right-pad for the × */
      border-radius:8px;                 /* square-ish corners */
      font-size:14px;
      line-height:1.25;
      cursor:pointer;white-space:nowrap;
      transition:background .15s ease;
    }
    .template-pill:hover     { background:#757575; }  /* ▲ changed */

    /* delete × inside pill */
    .delete-btn{                         /* ▲ changed */
      position:absolute;top:5px;right:10px;
      font-size:0.75rem;color:#d66;
      opacity:0;cursor:pointer;user-select:none;
      transition:opacity .15s ease;
    }
    .template-pill:hover .delete-btn { opacity:1; }
    /* delete button for folder headers (unchanged) */
    .folder-delete-btn{ position:absolute;top:6px;right:14px;
      font-size:0.8rem;color:#d66;opacity:0;cursor:pointer;
      transition:opacity .15s ease;user-select:none;}
    .folder-header:hover .folder-delete-btn{ opacity:1; }
  </style>
</head>

<body class="library">
  <div>
    <div class="container">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div></div>
        <button id="addBtn"       class="card" style="padding:8px 16px;">＋ New Template</button>
        <button id="newFolderBtn" class="card" style="padding:8px 16px;margin-left:.5rem;">＋ New Folder</button>
      </div>

      <div id="folderContainer" style="margin-top:1.5rem;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
/* ========== boot ========== */
async function initLibrary(){
  const folders = await fetch('/api/templates').then(r=>r.json());
  const allMap  = await fetch('/api/templates/all').then(r=>r.json());
  const data = {}; folders.forEach(f=>data[f]=allMap[f]||[]);
  buildLibrary(data);
}
initLibrary();

/* ========== render ========== */
function buildLibrary(data){
  const container=document.getElementById('folderContainer');
  container.innerHTML='';
  Object.entries(data).forEach(([folder,list])=>{
    const panel=document.createElement('div');panel.className='folder-panel';

    /* header */
    const header=document.createElement('div');header.className='folder-header';
    header.innerHTML=`<span class="folder-name">${folder||'(root)'}</span>
                      <span class="folder-toggle">▼</span>`;
    header.onclick=()=>panel.classList.toggle('collapsed');

    /* delete folder (not root) */
    if(folder!==''){
      const del=document.createElement('span');
      del.textContent='✕';del.className='folder-delete-btn';
      del.onclick=async e=>{
        e.stopPropagation();
        if(!confirm(`Delete folder “${folder}” and ALL its templates?`))return;
        const r=await fetch(`/api/templates?folder=${encodeURIComponent(folder)}`,{method:'DELETE'});
        if(r.ok) initLibrary(); else alert(await r.text());
      };
      header.appendChild(del);
    }

    /* body with pills */
    const body=document.createElement('div');body.className='folder-body';
    list.forEach(t=>{
      const pill=document.createElement('div');
      pill.className='template-pill'; pill.textContent=t.name;
      pill.onclick=()=>loadTemplate(t.id,t.name,folder);

      const del=document.createElement('span');
      del.textContent='✕';del.className='delete-btn';
      del.onclick=async e=>{
        e.stopPropagation();
        if(!confirm(`Delete “${t.name}”?`))return;
        const r=await fetch(`/api/templates/${t.id}`,{method:'DELETE'});
        if(r.ok) initLibrary(); else alert(await r.text());
      };
      pill.appendChild(del);
      body.appendChild(pill);
    });

    if(folder!=='') panel.classList.add('collapsed');
    panel.appendChild(header); panel.appendChild(body);
    container.appendChild(panel);
  });
}

/* ========== actions ========== */
document.getElementById('addBtn').onclick=()=>location.href='/formbuilder';

document.getElementById('newFolderBtn').onclick=async ()=>{
  const name=prompt('Enter new folder name:'); if(!name) return;
  const res=await fetch('/api/templates/folder',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name})});
  if(res.ok) await initLibrary(); else alert(await res.text());
};

async function loadTemplate(id,name,folder){
  try{
    const buf=await fetch(`/api/templates/${id}/download`).then(r=>r.arrayBuffer());
    const zip=await JSZip.loadAsync(buf);
    const form=await zip.file('form.json').async('string');
    localStorage.setItem('importedForm',form);
    localStorage.setItem('importedId',id);
    localStorage.setItem('importedName',name);
    localStorage.setItem('importedFolder',folder);
    location.href='/formbuilder';
  }catch(e){alert('Load failed: '+e.message);}
}
  </script>
</body>
</html>
